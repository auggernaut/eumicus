<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eumicus - Knowledge Reinforcement</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .main-pane {
            flex: 3;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #e2e8f0;
        }

        .activity-pane {
            flex: 1;
            background: #f1f5f9;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }

        .tab:hover {
            background: #f8fafc;
        }

        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
        }

        .message.user {
            align-self: flex-end;
            background: #3b82f6;
            color: white;
        }

        .message.ai {
            align-self: flex-start;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
        }

        .message.system {
            align-self: center;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            font-size: 0.9em;
            text-align: center;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .input-group {
            display: flex;
            gap: 12px;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: #3b82f6;
        }

        .send-button {
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .send-button:hover {
            background: #2563eb;
        }

        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .graph-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .graph-visualization {
            width: 100%;
            height: 100%;
            background: white;
        }

        .graph-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 8px;
        }

        .control-button {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .control-button:hover {
            background: #f3f4f6;
        }

        .activity-header {
            padding: 16px;
            background: #1e293b;
            color: white;
            font-weight: 600;
        }

        .activity-feed {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .activity-item {
            margin-bottom: 16px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .activity-item.processing {
            border-left-color: #f59e0b;
        }

        .activity-item.completed {
            border-left-color: #10b981;
        }

        .activity-item.error {
            border-left-color: #ef4444;
        }

        .activity-time {
            font-size: 0.75em;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .activity-agent {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .activity-message {
            font-size: 0.9em;
            color: #4b5563;
            margin-bottom: 8px;
        }

        .activity-details {
            font-size: 0.8em;
            color: #6b7280;
            background: #f9fafb;
            padding: 8px;
            border-radius: 4px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-in_progress {
            background: #f59e0b;
            animation: pulse 2s infinite;
        }

        .status-completed {
            background: #10b981;
        }

        .status-error {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .welcome-title {
            font-size: 2.5em;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
        }

        .welcome-subtitle {
            font-size: 1.2em;
            color: #64748b;
            margin-bottom: 32px;
            max-width: 600px;
        }

        .welcome-actions {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-button {
            padding: 12px 24px;
            border: 2px solid #3b82f6;
            background: white;
            color: #3b82f6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
        }

        .action-button:hover {
            background: #3b82f6;
            color: white;
        }

        .action-button.primary {
            background: #3b82f6;
            color: white;
        }

        .action-button.primary:hover {
            background: #2563eb;
        }

        .hidden {
            display: none !important;
        }

        /* Markdown styling for chat messages */
        .message h1, .message h2, .message h3, .message h4, .message h5, .message h6 {
            margin: 8px 0 4px 0;
            font-weight: 600;
            line-height: 1.3;
        }

        .message h1 { font-size: 1.3em; }
        .message h2 { font-size: 1.2em; }
        .message h3 { font-size: 1.1em; }

        .message ul, .message ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message li {
            margin: 4px 0;
            line-height: 1.4;
        }

        .message ol li {
            margin: 6px 0;
        }

        .message ul li {
            margin: 4px 0;
        }

        .message p {
            margin: 6px 0;
            line-height: 1.5;
        }

        .message strong {
            font-weight: 600;
        }

        .message em {
            font-style: italic;
        }

        .message code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .message pre {
            background: rgba(0, 0, 0, 0.1);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .message pre code {
            background: none;
            padding: 0;
        }

        .message blockquote {
            border-left: 3px solid rgba(0, 0, 0, 0.2);
            margin: 8px 0;
            padding-left: 12px;
            font-style: italic;
        }

        .message a {
            color: inherit;
            text-decoration: underline;
            opacity: 0.8;
        }

        .message a:hover {
            opacity: 1;
        }

        .message hr {
            border: none;
            border-top: 1px solid rgba(0, 0, 0, 0.2);
            margin: 12px 0;
        }

        /* Special styling for AI messages */
        .message.ai h1, .message.ai h2, .message.ai h3 {
            color: #1e40af;
        }

        .message.ai strong {
            color: #1e40af;
        }

        .message.ai code {
            background: rgba(59, 130, 246, 0.1);
        }

        .message.ai pre {
            background: rgba(59, 130, 246, 0.1);
        }

        .message.ai blockquote {
            border-left-color: #3b82f6;
        }

        /* Reflection tab styles */
        .reflection-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .reflection-header {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .reflection-header h2 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-size: 1.5em;
        }

        .reflection-header p {
            margin: 0;
            color: #64748b;
            font-size: 0.95em;
        }

        .reflection-actions {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .reflection-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .reflection-session {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .reflection-session h3 {
            margin-top: 0;
            color: #1e40af;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .insight-item {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            margin: 12px 0;
            border-radius: 0 6px 6px 0;
        }

        .insight-category {
            font-weight: 600;
            color: #1e40af;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insight-content {
            margin-top: 8px;
            line-height: 1.5;
        }

        .connection-item {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
        }

        .goal-progress-item {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
        }

        .next-step-item {
            background: #fefce8;
            border: 1px solid #fde047;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
        }

        .loading-reflection {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .reflection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
        }

        /* Interactive reflection styles */
        .reflection-progress {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            transition: width 0.3s ease;
        }

        .reflection-question {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }

        .reflection-question h4 {
            margin: 0 0 12px 0;
            color: #1e40af;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .question-text {
            font-size: 1.1em;
            line-height: 1.6;
            margin: 0 0 12px 0;
            color: #1e293b;
        }

        .question-context {
            color: #64748b;
            font-style: italic;
            margin: 0;
        }

        .reflection-input {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .reflection-input textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
        }

        .reflection-input textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .reflection-input .reflection-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-pane">
            <div class="tabs">
                <div class="tab active" data-tab="chat">Chat</div>
                <div class="tab" data-tab="graph">Knowledge Graph</div>
                <div class="tab" data-tab="reflection">Reflection</div>
            </div>

            <div class="tab-content active" id="chat-tab">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="welcome-screen" id="welcome-screen">
                            <h1 class="welcome-title">🧠 Welcome to Eumicus</h1>
                            <p class="welcome-subtitle">
                                Your AI-assisted knowledge reinforcement companion. Let's start by understanding your learning goals and interests.
                            </p>
                            <div class="welcome-actions">
                                <button class="action-button primary" onclick="startProfiling()">Start Learning Profile</button>
                                <button class="action-button" onclick="loadExistingProfile()">Load Existing Profile</button>
                            </div>
                        </div>
                    </div>
                    <div class="chat-input">
                        <div class="input-group">
                            <input type="text" class="input-field" id="message-input" placeholder="Type your message or paste a URL..." disabled>
                            <button class="send-button" id="send-button" onclick="sendMessage()" disabled>Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="graph-tab">
                <div class="graph-container">
                    <div class="graph-visualization" id="graph-visualization">
                        <div class="welcome-screen" id="graph-welcome">
                            <h1 class="welcome-title">📊 Knowledge Graph</h1>
                            <p class="welcome-subtitle">
                                Your knowledge will be visualized here as you learn and explore new concepts.
                            </p>
                        </div>
                    </div>
                    <div class="graph-controls">
                        <select id="categoryFilter" class="control-button">
                            <option value="">All Categories</option>
                        </select>
                        <select id="priorityFilter" class="control-button">
                            <option value="">All Priorities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <button class="control-button" onclick="resetGraphView()">Reset View</button>
                        <button class="control-button" onclick="exportGraph()">Export</button>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="reflection-tab">
                <div class="reflection-container">
                    <div class="reflection-header">
                        <h2>🤔 Learning Reflection</h2>
                        <p>Take time to reflect on your learning journey and connect new knowledge to your goals.</p>
                    </div>
                    
                    <div class="reflection-actions">
                        <button class="action-button primary" onclick="startReflectionSession()" id="start-reflection-btn">
                            Start Reflection Session
                        </button>
                        <button class="action-button" onclick="generateWeeklyReflection()" id="weekly-reflection-btn">
                            Generate Weekly Report
                        </button>
                        <button class="action-button" onclick="identifyLearningPatterns()" id="patterns-btn">
                            Analyze Learning Patterns
                        </button>
                    </div>

                    <div class="reflection-content" id="reflection-content">
                        <div class="welcome-screen" id="reflection-welcome">
                            <h1 class="welcome-title">🧠 Reflection Center</h1>
                            <p class="welcome-subtitle">
                                Use reflection to deepen your understanding and connect new knowledge to your goals.
                            </p>
                            <div class="welcome-actions">
                                <button class="action-button primary" onclick="startReflectionSession()">Start Reflection</button>
                                <button class="action-button" onclick="generateWeeklyReflection()">Weekly Report</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="activity-pane">
            <div class="activity-header">
                🤖 AI Activity Feed
            </div>
            <div class="activity-feed" id="activity-feed">
                <div class="activity-item">
                    <div class="activity-time">System Ready</div>
                    <div class="activity-agent">Eumicus</div>
                    <div class="activity-message">Welcome! Ready to start your learning journey.</div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script>
        let socket;
        let currentTab = 'chat';
        let isProfiling = false;
        let graphData = null;
        let network = null;
        let nodes = null;
        let edges = null;
        let allNodes = null;
        let allEdges = null;

        // Load knowledge graph data from server
        async function loadKnowledgeGraphData() {
            try {
                const response = await fetch('/api/knowledge-graph');
                if (response.ok) {
                    graphData = await response.json();
                    console.log('Knowledge graph data loaded:', graphData);
                }
            } catch (error) {
                console.error('Error loading knowledge graph:', error);
            }
        }

        // Initialize WebSocket connection
        function initSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
                addActivityItem('Connected to Eumicus server', 'system', 'completed');
                
                // Load initial knowledge graph data
                loadKnowledgeGraphData();
            });

            socket.on('activity', (activity) => {
                addActivityItem(activity.message, activity.agent, activity.status, activity.details);
            });

            socket.on('message', (message) => {
                removeTypingIndicator();
                addMessage(message.content, message.type || 'ai');
            });

            socket.on('profiling-question', (questionData) => {
                addMessage(`📋 Phase: ${questionData.phaseTitle}\n\n❓ ${questionData.question}`, 'ai');
                addMessage(`Progress: ${questionData.progress.currentPhase}/${questionData.progress.totalPhases} phases, ${questionData.progress.currentQuestion}/${questionData.progress.totalQuestions} questions`, 'system');
            });

            socket.on('profiling-complete', (profile) => {
                addMessage('✅ Great! I\'ve completed analyzing your learning profile. Here\'s what I learned about you:', 'ai');
                addMessage(`🎯 Goals: ${profile.goals.join(', ')}`, 'ai');
                addMessage(`💡 Interests: ${profile.interests.join(', ')}`, 'ai');
                addMessage(`📚 Current Knowledge: ${profile.current_knowledge.join(', ')}`, 'ai');
                addMessage(`🎨 Learning Style: ${profile.learning_style}`, 'ai');
                addMessage('Now you can start chatting with me or share URLs to build your knowledge graph!', 'ai');
            });

            socket.on('profile-loaded', (profile) => {
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('message-input').disabled = false;
                document.getElementById('send-button').disabled = false;
                
                addMessage('Welcome back! I\'ve loaded your existing profile:', 'ai');
                addMessage(`🎯 Goals: ${profile.goals.join(', ')}`, 'ai');
                addMessage(`💡 Interests: ${profile.interests.join(', ')}`, 'ai');
                addMessage(`📚 Current Knowledge: ${profile.current_knowledge.join(', ')}`, 'ai');
                addMessage(`🎨 Learning Style: ${profile.learning_style}`, 'ai');
                addMessage('You can continue chatting with me or share URLs to build your knowledge graph!', 'ai');
            });

            socket.on('no-profile', (data) => {
                addMessage('No existing profile found. Let\'s create one!', 'ai');
                addMessage('Click "Start Learning Profile" to begin.', 'system');
            });

            socket.on('graph-update', (data) => {
                graphData = data;
                if (currentTab === 'graph') {
                    updateGraphVisualization();
                }
            });

            socket.on('disconnect', () => {
                addActivityItem('Disconnected from server', 'system', 'error');
            });

            socket.on('error', (error) => {
                console.error('Socket error:', error);
                addActivityItem('Connection error: ' + error.message, 'system', 'error');
            });
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // Update tab appearance
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            currentTab = tabName;

            // Update graph if switching to graph tab
            if (tabName === 'graph' && graphData) {
                updateGraphVisualization();
            }
        }

        // Chat functionality
        function startProfiling() {
            isProfiling = true;
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-button').disabled = false;
            
            addMessage("Hello! I'm Eumicus, your AI learning companion. Let's start by understanding your learning goals and interests.", 'ai');
            
            socket.emit('start-profiling');
        }

        function loadExistingProfile() {
            socket.emit('load-profile');
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            const typingId = addMessage('Thinking...', 'ai', true);
            
            socket.emit('message', { content: message, type: 'user' });
        }

        function addMessage(content, type, isTyping = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (isTyping) {
                messageDiv.innerHTML = `<span class="loading"></span> ${content}`;
                messageDiv.id = 'typing-message';
            } else {
                // Render markdown for AI messages, plain text for user messages
                if (type === 'ai' || type === 'system') {
                    try {
                        // Configure marked options
                        marked.setOptions({
                            breaks: true,
                            gfm: true,
                            sanitize: false
                        });
                        messageDiv.innerHTML = marked.parse(content);
                    } catch (error) {
                        console.error('Markdown parsing error:', error);
                        messageDiv.textContent = content;
                    }
                } else {
                    messageDiv.textContent = content;
                }
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv.id;
        }

        function removeTypingIndicator() {
            const typingMessage = document.getElementById('typing-message');
            if (typingMessage) {
                typingMessage.remove();
            }
        }

        // Activity feed
        function addActivityItem(message, agent, status, details = null) {
            const feed = document.getElementById('activity-feed');
            const item = document.createElement('div');
            item.className = `activity-item ${status}`;
            
            const time = new Date().toLocaleTimeString();
            const statusClass = `status-${status}`;
            
            let detailsHtml = '';
            if (details) {
                detailsHtml = `<div class="activity-details">${JSON.stringify(details, null, 2)}</div>`;
            }
            
            item.innerHTML = `
                <div class="activity-time">${time}</div>
                <div class="activity-agent">
                    <span class="status-indicator ${statusClass}"></span>
                    ${agent}
                </div>
                <div class="activity-message">${message}</div>
                ${detailsHtml}
            `;
            
            feed.insertBefore(item, feed.firstChild);
            
            // Keep only last 50 activities
            while (feed.children.length > 50) {
                feed.removeChild(feed.lastChild);
            }
        }

        // Graph visualization with Vis.js
        function updateGraphVisualization() {
            if (!graphData || !graphData.concepts) return;

            const container = document.getElementById('graph-visualization');
            const welcomeScreen = document.getElementById('graph-welcome');
            
            // Hide welcome screen
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }

            // Clear container
            container.innerHTML = '';

            // Create nodes from concepts
            allNodes = new vis.DataSet();
            allEdges = new vis.DataSet();

            // Add concept nodes
            graphData.concepts.forEach(concept => {
                const node = {
                    id: concept.name,
                    label: concept.name,
                    title: concept.description,
                    color: getCategoryColor(concept.category),
                    size: Math.max(10, concept.confidence * 20),
                    shape: 'dot',
                    borderWidth: 2,
                    borderColor: getPriorityColor(concept.priority),
                    font: {
                        size: 12,
                        color: '#333'
                    }
                };
                allNodes.add(node);

                // Add edges for connections
                if (concept.connections) {
                    concept.connections.forEach(connection => {
                        const edge = {
                            from: concept.name,
                            to: connection,
                            color: {
                                color: '#848484',
                                highlight: '#007bff'
                            },
                            width: 2,
                            smooth: {
                                type: 'continuous'
                            }
                        };
                        allEdges.add(edge);
                    });
                }
            });

            // Add content item nodes
            graphData.content_items.forEach((item, index) => {
                const nodeId = `content_${index}`;
                const node = {
                    id: nodeId,
                    label: `📹 ${item.title.substring(0, 30)}...`,
                    title: item.title,
                    color: '#ff6b6b',
                    size: 15,
                    shape: 'square',
                    borderWidth: 2,
                    borderColor: '#ff4757'
                };
                allNodes.add(node);

                // Connect content to concepts
                if (item.key_concepts) {
                    item.key_concepts.forEach(conceptName => {
                        const edge = {
                            from: nodeId,
                            to: conceptName,
                            color: {
                                color: '#ff6b6b',
                                highlight: '#ff4757'
                            },
                            width: 3,
                            dashes: true
                        };
                        allEdges.add(edge);
                    });
                }
            });

            // Initialize with all data
            nodes = allNodes;
            edges = allEdges;

            // Populate category filter
            populateCategoryFilter();

            // Create network
            createNetwork();
        }

        function getCategoryColor(category) {
            const colors = {
                'Programming': '#4CAF50',
                'Machine Learning': '#2196F3',
                'Mathematics': '#FF9800',
                'business': '#9C27B0',
                'AI': '#E91E63',
                'sales': '#795548',
                'science': '#607D8B',
                'AI Application': '#3F51B5',
                'AI Technology': '#00BCD4',
                'AI Theory': '#8BC34A'
            };
            return colors[category] || '#9E9E9E';
        }

        function getPriorityColor(priority) {
            const colors = {
                'high': '#dc3545',
                'medium': '#ffc107',
                'low': '#28a745'
            };
            return colors[priority] || '#6c757d';
        }

        function populateCategoryFilter() {
            if (!graphData || !graphData.concepts) return;
            
            const categories = [...new Set(graphData.concepts.map(c => c.category))];
            const select = document.getElementById('categoryFilter');
            
            // Clear existing options except "All Categories"
            select.innerHTML = '<option value="">All Categories</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }

        function createNetwork() {
            const container = document.getElementById('graph-visualization');
            const data = { nodes: nodes, edges: edges };
            
            const options = {
                nodes: {
                    font: {
                        size: 14,
                        color: '#333'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    color: {
                        color: '#848484',
                        highlight: '#007bff'
                    },
                    width: 2,
                    smooth: {
                        type: 'continuous'
                    },
                    shadow: true
                },
                physics: {
                    enabled: true,
                    stabilization: { iterations: 100 },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.3,
                        springLength: 95,
                        springConstant: 0.04,
                        damping: 0.09
                    }
                },
                interaction: {
                    hover: true,
                    selectConnectedEdges: false
                }
            };

            network = new vis.Network(container, data, options);

            // Add event listeners
            network.on('selectNode', function (params) {
                if (params.nodes.length > 0) {
                    showNodeInfo(params.nodes[0]);
                }
            });

            network.on('deselectNode', function () {
                hideNodeInfo();
            });
        }

        function showNodeInfo(nodeId) {
            const concept = graphData.concepts.find(c => c.name === nodeId);
            const contentItem = graphData.content_items.find((item, index) => `content_${index}` === nodeId);

            if (concept) {
                // Create a simple info display
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = `
                    position: absolute;
                    top: 20px;
                    left: 20px;
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    max-width: 300px;
                    z-index: 1000;
                `;
                
                infoDiv.innerHTML = `
                    <h3 style="margin-top: 0; color: #333;">${concept.name}</h3>
                    <p style="color: #666; margin: 10px 0;">${concept.description}</p>
                    <div style="margin: 10px 0;">
                        <strong>Confidence:</strong> ${(concept.confidence * 100).toFixed(0)}%
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>Priority:</strong> 
                        <span style="background: ${getPriorityColor(concept.priority)}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                            ${concept.priority}
                        </span>
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>Category:</strong> 
                        <span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                            ${concept.category}
                        </span>
                    </div>
                    ${concept.connections && concept.connections.length > 0 ? `
                        <div style="margin: 10px 0;">
                            <strong>Connections:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                ${concept.connections.map(conn => `<li>${conn}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
                
                // Remove existing info if any
                const existingInfo = document.querySelector('.node-info-display');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                infoDiv.className = 'node-info-display';
                document.getElementById('graph-visualization').appendChild(infoDiv);
            }
        }

        function hideNodeInfo() {
            const existingInfo = document.querySelector('.node-info-display');
            if (existingInfo) {
                existingInfo.remove();
            }
        }

        function resetGraphView() {
            if (graphData) {
                updateGraphVisualization();
            }
        }

        function exportGraph() {
            if (graphData) {
                const dataStr = JSON.stringify(graphData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'knowledge-graph.json';
                link.click();
            }
        }

        // Filter functionality
        function applyFilters() {
            if (!allNodes || !allEdges) return;

            const categoryFilter = document.getElementById('categoryFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;

            const filteredNodes = allNodes.get().filter(node => {
                const concept = graphData.concepts.find(c => c.name === node.id);
                if (!concept) return true; // Keep content nodes

                const categoryMatch = !categoryFilter || concept.category === categoryFilter;
                const priorityMatch = !priorityFilter || concept.priority === priorityFilter;

                return categoryMatch && priorityMatch;
            });

            const filteredNodeIds = filteredNodes.map(n => n.id);
            const filteredEdges = allEdges.get().filter(edge => 
                filteredNodeIds.includes(edge.from) && filteredNodeIds.includes(edge.to)
            );

            nodes.clear();
            edges.clear();
            nodes.add(filteredNodes);
            edges.add(filteredEdges);
        }

        // Reflection functionality
        let currentReflectionSession = null;

        async function startReflectionSession() {
            const content = document.getElementById('reflection-content');
            const welcome = document.getElementById('reflection-welcome');
            
            if (welcome) {
                welcome.style.display = 'none';
            }
            
            content.innerHTML = `
                <div class="loading-reflection">
                    <div class="loading"></div>
                    <p>Starting reflection session...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/reflection-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const session = await response.json();
                    console.log('Reflection session created:', session);
                    currentReflectionSession = session;
                    await showNextReflectionQuestion(session.id);
                } else {
                    throw new Error('Failed to start reflection session');
                }
            } catch (error) {
                console.error('Error starting reflection session:', error);
                content.innerHTML = `
                    <div class="reflection-session">
                        <h3>❌ Error</h3>
                        <p>Failed to start reflection session: ${error.message}</p>
                        <button class="action-button" onclick="startReflectionSession()">Try Again</button>
                    </div>
                `;
            }
        }

        async function showNextReflectionQuestion(sessionId) {
            const content = document.getElementById('reflection-content');
            
            try {
                const response = await fetch(`/api/reflection-question/${sessionId}`);
                if (response.ok) {
                    const question = await response.json();
                    console.log('Got reflection question:', question);
                    if (question) {
                        displayReflectionQuestion(question);
                    } else {
                        // No more questions, session complete
                        console.log('No more questions, session complete');
                        displayReflectionComplete();
                    }
                } else {
                    throw new Error('Failed to get reflection question');
                }
            } catch (error) {
                console.error('Error getting reflection question:', error);
                content.innerHTML = `
                    <div class="reflection-session">
                        <h3>❌ Error</h3>
                        <p>Failed to get reflection question: ${error.message}</p>
                        <button class="action-button" onclick="showNextReflectionQuestion('${sessionId}')">Try Again</button>
                    </div>
                `;
            }
        }

        function displayReflectionQuestion(question) {
            const content = document.getElementById('reflection-content');
            
            content.innerHTML = `
                <div class="reflection-session">
                    <div class="reflection-progress">
                        <h3>🤔 Reflection Question ${question.questionIndex + 1} of ${question.totalQuestions}</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${((question.questionIndex + 1) / question.totalQuestions) * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="reflection-question">
                        <h4>${question.category.replace('_', ' ').toUpperCase()}</h4>
                        <p class="question-text">${question.question}</p>
                        ${question.context ? `<p class="question-context"><em>${question.context}</em></p>` : ''}
                    </div>
                    
                    <div class="reflection-input">
                        <textarea id="reflection-response" placeholder="Take a moment to reflect and share your thoughts..." rows="6"></textarea>
                        <div class="reflection-actions">
                            <button class="action-button primary" onclick="submitReflectionResponse('${question.sessionId}')">
                                Submit Response
                            </button>
                            <button class="action-button" onclick="skipReflectionQuestion('${question.sessionId}')">
                                Skip Question
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function submitReflectionResponse(sessionId) {
            const responseText = document.getElementById('reflection-response').value.trim();
            
            if (!responseText) {
                alert('Please provide a response before submitting.');
                return;
            }
            
            const content = document.getElementById('reflection-content');
            content.innerHTML = `
                <div class="loading-reflection">
                    <div class="loading"></div>
                    <p>Processing your reflection...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/reflection-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        response: responseText
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.isComplete) {
                        // Session complete, show results
                        displayReflectionSession(currentReflectionSession);
                    } else {
                        // Show next question
                        await showNextReflectionQuestion(sessionId);
                    }
                } else {
                    throw new Error('Failed to submit reflection response');
                }
            } catch (error) {
                console.error('Error submitting reflection response:', error);
                content.innerHTML = `
                    <div class="reflection-session">
                        <h3>❌ Error</h3>
                        <p>Failed to submit response: ${error.message}</p>
                        <button class="action-button" onclick="showNextReflectionQuestion('${sessionId}')">Try Again</button>
                    </div>
                `;
            }
        }

        async function skipReflectionQuestion(sessionId) {
            await submitReflectionResponse(sessionId); // Submit empty response
        }

        function displayReflectionComplete() {
            const content = document.getElementById('reflection-content');
            content.innerHTML = `
                <div class="reflection-session">
                    <h3>✅ Reflection Session Complete!</h3>
                    <p>Thank you for taking the time to reflect on your learning journey.</p>
                    <button class="action-button primary" onclick="startReflectionSession()">Start New Reflection</button>
                </div>
            `;
        }

        async function generateWeeklyReflection() {
            const content = document.getElementById('reflection-content');
            const welcome = document.getElementById('reflection-welcome');
            
            if (welcome) {
                welcome.style.display = 'none';
            }
            
            content.innerHTML = `
                <div class="loading-reflection">
                    <div class="loading"></div>
                    <p>Generating weekly reflection report...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/weekly-reflection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const report = await response.json();
                    displayWeeklyReport(report);
                } else {
                    throw new Error('Failed to generate weekly report');
                }
            } catch (error) {
                console.error('Error generating weekly report:', error);
                content.innerHTML = `
                    <div class="reflection-session">
                        <h3>❌ Error</h3>
                        <p>Failed to generate weekly report: ${error.message}</p>
                        <button class="action-button" onclick="generateWeeklyReflection()">Try Again</button>
                    </div>
                `;
            }
        }

        async function identifyLearningPatterns() {
            const content = document.getElementById('reflection-content');
            const welcome = document.getElementById('reflection-welcome');
            
            if (welcome) {
                welcome.style.display = 'none';
            }
            
            content.innerHTML = `
                <div class="loading-reflection">
                    <div class="loading"></div>
                    <p>Analyzing learning patterns...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/learning-patterns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const patterns = await response.json();
                    displayLearningPatterns(patterns);
                } else {
                    throw new Error('Failed to analyze learning patterns');
                }
            } catch (error) {
                console.error('Error analyzing learning patterns:', error);
                content.innerHTML = `
                    <div class="reflection-session">
                        <h3>❌ Error</h3>
                        <p>Failed to analyze learning patterns: ${error.message}</p>
                        <button class="action-button" onclick="identifyLearningPatterns()">Try Again</button>
                    </div>
                `;
            }
        }

        function displayReflectionSession(session) {
            const content = document.getElementById('reflection-content');
            
            let html = `
                <div class="reflection-session">
                    <h3>🤔 Reflection Session - ${new Date(session.start_time).toLocaleDateString()}</h3>
                    <p><strong>Status:</strong> ${session.status}</p>
                    <p><strong>Insights Generated:</strong> ${session.insights.length}</p>
            `;
            
            if (session.insights.length > 0) {
                html += '<h4>Key Insights</h4>';
                session.insights.forEach(insight => {
                    html += `
                        <div class="insight-item">
                            <div class="insight-category">${insight.category.replace('_', ' ')}</div>
                            <div class="insight-content">
                                <strong>Question:</strong> ${insight.prompt}<br>
                                <strong>Insight:</strong> ${insight.user_response}
                            </div>
                        </div>
                    `;
                });
            }
            
            if (session.connections_made && session.connections_made.length > 0) {
                html += '<h4>New Connections Made</h4>';
                session.connections_made.forEach(connection => {
                    html += `
                        <div class="connection-item">
                            <strong>${connection.concept1}</strong> ↔ <strong>${connection.concept2}</strong><br>
                            <em>${connection.relationship}</em><br>
                            ${connection.significance}
                        </div>
                    `;
                });
            }
            
            if (session.goals_progress && session.goals_progress.length > 0) {
                html += '<h4>Goal Progress</h4>';
                session.goals_progress.forEach(goal => {
                    html += `
                        <div class="goal-progress-item">
                            <strong>${goal.goal}</strong> - ${goal.progress_level}<br>
                            <em>Evidence:</em> ${goal.evidence}<br>
                            ${goal.next_milestone ? `<em>Next:</em> ${goal.next_milestone}` : ''}
                        </div>
                    `;
                });
            }
            
            if (session.next_steps && session.next_steps.length > 0) {
                html += '<h4>Recommended Next Steps</h4>';
                session.next_steps.forEach(step => {
                    html += `
                        <div class="next-step-item">
                            <strong>${step.action}</strong> (${step.priority} priority)<br>
                            <em>Timeline:</em> ${step.timeline}<br>
                            ${step.rationale ? `<em>Why:</em> ${step.rationale}` : ''}
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        function displayWeeklyReport(report) {
            const content = document.getElementById('reflection-content');
            
            let html = `
                <div class="reflection-session">
                    <h3>📅 Weekly Learning Report</h3>
                    <p><strong>Summary:</strong> ${report.summary}</p>
            `;
            
            if (report.key_achievements && report.key_achievements.length > 0) {
                html += '<h4>Key Achievements</h4><ul>';
                report.key_achievements.forEach(achievement => {
                    html += `<li>${achievement}</li>`;
                });
                html += '</ul>';
            }
            
            if (report.knowledge_growth) {
                html += `<h4>Knowledge Growth</h4><p>${report.knowledge_growth}</p>`;
            }
            
            if (report.goal_progress) {
                html += `<h4>Goal Progress</h4><p>${report.goal_progress}</p>`;
            }
            
            if (report.areas_for_improvement && report.areas_for_improvement.length > 0) {
                html += '<h4>Areas for Improvement</h4><ul>';
                report.areas_for_improvement.forEach(area => {
                    html += `<li>${area}</li>`;
                });
                html += '</ul>';
            }
            
            if (report.next_week_recommendations && report.next_week_recommendations.length > 0) {
                html += '<h4>Next Week Recommendations</h4><ul>';
                report.next_week_recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += '</ul>';
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        function displayLearningPatterns(patterns) {
            const content = document.getElementById('reflection-content');
            
            let html = `
                <div class="reflection-session">
                    <h3>🔍 Learning Pattern Analysis</h3>
            `;
            
            if (patterns.learning_preferences && patterns.learning_preferences.length > 0) {
                html += '<h4>Learning Preferences</h4><ul>';
                patterns.learning_preferences.forEach(pref => {
                    html += `<li>${pref}</li>`;
                });
                html += '</ul>';
            }
            
            if (patterns.knowledge_patterns && patterns.knowledge_patterns.length > 0) {
                html += '<h4>Knowledge Patterns</h4><ul>';
                patterns.knowledge_patterns.forEach(pattern => {
                    html += `<li>${pattern}</li>`;
                });
                html += '</ul>';
            }
            
            if (patterns.recommendations && patterns.recommendations.length > 0) {
                html += '<h4>Recommendations</h4><ul>';
                patterns.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += '</ul>';
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', () => {
            // Add filter event listeners after DOM is loaded
            setTimeout(() => {
                const categoryFilter = document.getElementById('categoryFilter');
                const priorityFilter = document.getElementById('priorityFilter');
                
                if (categoryFilter) {
                    categoryFilter.addEventListener('change', applyFilters);
                }
                if (priorityFilter) {
                    priorityFilter.addEventListener('change', applyFilters);
                }
            }, 100);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.id === 'message-input') {
                sendMessage();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initSocket();
        });
    </script>
</body>
</html>
